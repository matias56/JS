<style>html,body,canvas{margin: 0px;padding: 0px;}</style>
<canvas id="screen" style="width: 100%; height: 100%"/>
<script>
    const canvas = document.getElementById('screen');
    const context = canvas.getContext('2d');

    const FPS = 60;
    const cycleDelay  = Math.floor(1000/FPS);
    var oldCycleTime =0;
    var cycleCount=0;
    var  fps_rate = '...';

    const MAP_SIZE  = 32;
    const MAP_SCALE = 64;
    const MAP_RANGE = MAP_SCALE * MAP_SIZE;
    const MAP_SPEED = (MAP_SCALE / 2) / 10;
    var Map = [
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,
        1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 6, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,
        1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 8, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 9, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    ];
    var showMap = false;

    var playerX=MAP_SCALE + 20;
    var playerY= MAP_SCALE + 20;
    var playerAngle = Math.PI/3;
    var playerMoveX = 0;
    var playerMoveY = 0;
    var playerMoveAngle = 0;

    document.onkeydown = function(event)
    {
        
        switch(event.keyCode)
        {
            case 40: playerMoveX = -1; playerMoveY = -1; break;
            case 38: playerMoveX = 1; playerMoveY = 1; break;
            case 37: playerMoveAngle = 1; break;
            case 39: playerMoveAngle = -1; break;
            case 16: showMap =  true; break;
        }
    }

    document.onkeyup = function(event)
    {
         switch (event.keyCode) {
            case 40: 
            case 38: playerMoveX = 0; playerMoveY = 0; break;
            case 37:
            case 39: playerMoveAngle = 0; break;
            case 16: showMap = false; break;
        }
    }

    const DOUBLE_PI = 2 * Math.PI;
    const WIDTH = 300, HALF_WIDTH = 150;
    const HEIGHT = 200, HALF_HEIGHT = 100;

    var i =0;

    const FOV = Math.PI / 3;
    const HALF_FOV = FOV / 2;
    const STEP_ANGLE =  FOV / WIDTH;

    const WALLS  = [];

    for(filename=0;filename<10;filename++)
    {
        var image = document.createElement('img');
        image.src  = 'Assets/Walls/' + filename + '.png';
        WALLS.push(image);
    }

    function gameLoop(){

        cycleCount++;
        if(cycleCount >=60) cycleCount =0;
        var startTime=Date.now();
        var cycleTime = startTime - oldCycleTime;
        oldCycleTime = startTime;
        if(cycleTime %  60 == 0)  fps_rate = Math.floor(1000/cycleTime);
        canvas.width = window.innerWidth*0.3;
        canvas.height = window.innerHeight*0.3;


        

        var playerOffsetX = Math.sin(playerAngle) * MAP_SPEED;
        var playerOffsetY = Math.cos(playerAngle)*MAP_SPEED;
        var mapTargetX = Math.floor(playerY/MAP_SCALE) * MAP_SIZE + Math.floor((playerX + playerOffsetX * playerMoveX * 10)/MAP_SCALE);
        var mapTargetY = Math.floor((playerY + playerOffsetY  * playerMoveY * 10) / MAP_SCALE) * MAP_SIZE + Math.floor(playerX/ MAP_SCALE);
        if(playerMoveX&&Map[mapTargetX]==0) playerX += playerOffsetX * playerMoveX;
        if (playerMoveY && Map[mapTargetY] == 0) playerY += playerOffsetY * playerMoveY;
        if (playerMoveAngle) playerAngle += 0.03 * playerMoveAngle;
        var mapOffsetX = Math.floor(canvas.width/2) - HALF_WIDTH;
        var mapOffsetY = Math.floor(canvas.height / 2) - HALF_HEIGHT;
        var playerMapX = (playerX / MAP_SCALE) * 5 + mapOffsetX;
        var playerMapY = (playerY / MAP_SCALE)  *  5 + mapOffsetY;

        context.drawImage(WALLS[0], canvas.width/2-HALF_WIDTH,canvas.height/2-HALF_HEIGHT);

        var currentAngle = playerAngle + HALF_FOV;
        var rayStartX = Math.floor(playerX / MAP_SCALE) * MAP_SCALE;
        var rayStartY = Math.floor(playerY / MAP_SCALE) * MAP_SCALE;

        for(var ray = 0; ray < WIDTH; ray++)
        {
        var currentSin = Math.sin(currentAngle); currentSin = currentSin ? currentSin : 0.000001;
        var currentCos = Math.cos(currentAngle); currentCos = currentCos ? currentCos : 0.000001;

        var rayEndX, rayEndY, rayDirectionX, verticalDepth, textureEndY, textureY;
        if(currentSin > 0)
        {
            rayEndX = rayStartX + MAP_SCALE; rayDirectionX = 1
        }
        else
        {
            rayEndX = rayStartX; rayDirectionX = -1
        }
        for (var offset = 0; offset < MAP_RANGE; offset  += MAP_SCALE)
        {
            verticalDepth = (rayEndX - playerX)  / currentSin;
            rayEndY = playerY + verticalDepth * currentCos;
            var mapTargetX = Math.floor(rayEndX/MAP_SCALE);
            var mapTargetY = Math.floor(rayEndY/MAP_SCALE);
            if(currentSin <= 0) mapTargetX += rayDirectionX;
            var targetSquare = mapTargetY * MAP_SIZE + mapTargetX;
            if(targetSquare <0 || targetSquare > Map.length - 1) break;
            if(Map[targetSquare] != 0) {textureY=Map[targetSquare];break;}
            rayEndX += rayDirectionX * MAP_SCALE;
        }
        textureEndY = rayEndY;

       

        var rayEndY, rayEndX, rayDirectionY, horizontalDepth, textureEndX, textureX;
        if (currentCos > 0) {
            rayEndY = rayStartY + MAP_SCALE; rayDirectionY = 1
        }
        else {
            rayEndY = rayStartY; rayDirectionY = -1
        }
        for (var offset = 0; offset < MAP_RANGE; offset += MAP_SCALE) {
            horizontalDepth = (rayEndY - playerY) / currentCos;
            rayEndX = playerX + horizontalDepth * currentSin;
            var mapTargetX = Math.floor(rayEndX / MAP_SCALE);
            var mapTargetY = Math.floor(rayEndY / MAP_SCALE);
            if (currentCos <= 0) mapTargetY += rayDirectionY;
            var targetSquare = mapTargetY * MAP_SIZE + mapTargetX;
            if (targetSquare < 0 || targetSquare > Map.length - 1) break;
            if (Map[targetSquare] != 0) { textureX = Map[targetSquare]; break; }
            rayEndY += rayDirectionY * MAP_SCALE;
        }
        textureEndX = rayEndX;

        var depth = verticalDepth < horizontalDepth  ? verticalDepth : horizontalDepth;
        var textureImage = verticalDepth < horizontalDepth ? textureY : textureX;
        var textureOffset = verticalDepth < horizontalDepth ? textureEndY : textureEndX;
        textureOffset = Math.floor(textureOffset - Math.floor(textureOffset / MAP_SCALE) * MAP_SCALE);

        depth *= Math.cos(playerAngle - currentAngle);

        var wallHeight  = Math.min(MAP_SCALE * 280/(depth+0.0001), 50000);
        //context.fillStyle = verticalDepth < horizontalDepth ? '#aaa':'#555';
        //context.fillRect(mapOffsetX + ray, mapOffsetY + (HALF_HEIGHT-wallHeight/2), 1,  wallHeight);

        context.drawImage(WALLS[textureImage], textureOffset,0,1,64,mapOffsetX + ray,mapOffsetY + (HALF_HEIGHT - Math.floor(wallHeight / 2)),1,wallHeight,)
       
        currentAngle -= STEP_ANGLE;
    }

    if(showMap)
    {
    for (var row = 0; row < MAP_SIZE; row++) {
            for (var col = 0; col < MAP_SIZE; col++) {
                var square = row * MAP_SIZE + col;
                if (Map[square] != 0) {
                    context.fillStyle = '#555';
                    context.fillRect(mapOffsetX + col * 5, mapOffsetY + row * 5, 5, 5);
                } else {
                    context.fillStyle = '#aaa';
                    context.fillRect(mapOffsetX + col * 5, mapOffsetY + row * 5, 5, 5);
                }
            }
        }

        context.fillStyle = 'Red';
        context.beginPath();
        context.arc(playerMapX, playerMapY, 2, 0, DOUBLE_PI);
        context.fill();
        context.strokeStyle = 'Red';
        context.lineWidth = 1;
        context.beginPath();
        context.moveTo(playerMapX, playerMapY);
        context.lineTo(playerMapX + Math.sin(playerAngle) * 5, playerMapY + Math.cos(playerAngle) * 5);
        context.stroke();
    }

        context.fillStyle = 'White';
        context.fillRect(0, 0, canvas.width, mapOffsetY);
        context.fillRect(0,mapOffsetY + 200,canvas.width, canvas.width - mapOffsetY + 200);

        setTimeout(gameLoop,cycleDelay);

        context.fillStyle='Black';
        context.font='10px Monospace';
        context.fillText('FPS: '+fps_rate,0,20);

    } window.onload = function() {gameLoop();}
</script>